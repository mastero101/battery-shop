<div class="container my-4" *ngIf="product">
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a routerLink="/">Inicio</a></li>
      <li class="breadcrumb-item"><a routerLink="/products">Productos</a></li>
      <li class="breadcrumb-item active" aria-current="page">{{ product.name }}</li>
    </ol>
  </nav>

  <div class="row">
    <!-- Galería de imágenes -->
    <div class="col-lg-6 mb-4">
      <div class="card border-0 shadow-sm">
        <img [src]="selectedImage" 
             class="card-img-top" 
             [alt]="product.name"
             style="height: 400px; object-fit: contain;">
        <div class="card-body">
          <div class="d-flex overflow-auto py-2">
            <div class="me-2 cursor-pointer" 
                 *ngFor="let img of [product.image]; let i = index"
                 (click)="selectImage(img)">
              <img [src]="img" 
                   class="img-thumbnail" 
                   [alt]="'Imagen ' + (i+1)"
                   style="height: 80px; width: 80px; object-fit: cover;"
                   [class.border-primary]="selectedImage === img">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Información del producto -->
    <div class="col-lg-6">
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <div>
              <h1 class="h3 mb-2">{{ product.name }}</h1>
              <span class="badge bg-primary">{{ product.chemistry }}</span>
              <span class="badge bg-secondary ms-2">{{ product.format }}</span>
              <span class="badge bg-info ms-2">{{ product.application }}</span>
            </div>
            <div *ngIf="product.discount" class="bg-danger text-white px-2 py-1 rounded">
              -{{ product.discount }}%
            </div>
          </div>

          <p class="text-muted mb-4">{{ product.description }}</p>

          <div class="row mb-4">
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="mb-2"><strong>Capacidad:</strong> {{ getCapacityDisplay() }}</li>
                <li class="mb-2"><strong>Voltaje:</strong> {{ product.voltage }}V</li>
                <li class="mb-2"><strong>Química:</strong> {{ product.chemistry }}</li>
                <li class="mb-2" *ngIf="product.weight"><strong>Peso:</strong> {{ product.weight }}g</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-unstyled">
                <li class="mb-2"><strong>Formato:</strong> {{ product.format }}</li>
                <li class="mb-2"><strong>Aplicación:</strong> {{ product.application }}</li>
                <li class="mb-2" *ngIf="product.cells"><strong>Celdas:</strong> {{ product.cells }}</li>
                <li class="mb-2" *ngIf="product.operatingTemperature"><strong>Temperatura:</strong> {{ product.operatingTemperature }}</li>
              </ul>
            </div>
          </div>

          <div class="d-flex align-items-center mb-4">
            <div class="me-3">
              <span class="h4 mb-0" *ngIf="!product.discount">${{ product.price }}</span>
              <div *ngIf="product.discount">
                <span class="h4 text-danger mb-0">${{ getProductPrice() | number:'1.2-2' }}</span>
                <div class="small text-muted text-decoration-line-through">${{ product.price }}</div>
              </div>
            </div>
          </div>

          <!-- Fila para cantidad y botón de agregar al carrito -->
          <div class="d-flex align-items-center gap-3 mb-3">
            <!-- Selector de cantidad -->
            <div class="d-flex align-items-center">
              <label class="form-label fw-bold me-2 mb-0">Cantidad:</label>
              <div class="input-group" style="width: 140px;">
                <button class="btn btn-outline-secondary" type="button" (click)="decrementQuantity()">
                  <i class="bi bi-dash"></i>
                </button>
                <input type="number" 
                       class="form-control text-center" 
                       [value]="quantity" 
                       min="1" 
                       [max]="maxQuantity"
                       (change)="updateQuantity($event)"
                       (keyup)="updateQuantity($event)">
                <button class="btn btn-outline-secondary" type="button" (click)="incrementQuantity()">
                  <i class="bi bi-plus"></i>
                </button>
              </div>
            </div>
            
            <!-- Botón de agregar al carrito -->
            <button (click)="addToCart($event, product)" class="btn btn-primary btn-lg flex-grow-1">
              <i class="bi bi-cart-plus"></i> Agregar al carrito ({{ quantity }})
            </button>
          </div>
          
          <!-- Botón de favoritos -->
          <ng-container *ngIf="product">
            <button 
              class="btn w-100" 
              [class.btn-outline-secondary]="!product.isFavorite"
              [class.btn-danger]="product.isFavorite"
              (click)="toggleFavorite(product, $event)">
              <i [class.bi-heart]="!product.isFavorite" 
                 [class.bi-heart-fill]="product.isFavorite"></i> 
              {{ product.isFavorite ? 'En favoritos' : 'Agregar a favoritos' }}
            </button>
          </ng-container>
        </div>
      </div>

      <!-- Especificaciones técnicas -->
      <div class="card border-0 shadow-sm mt-4">
        <div class="card-header bg-white">
          <h5 class="mb-0">Especificaciones Técnicas</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Capacidad Nominal</span>
                  <span>{{ getCapacityDisplay() }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Voltaje Nominal</span>
                  <span>{{ product.voltage }}V</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Química</span>
                  <span>{{ product.chemistry }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between" *ngIf="product.weight">
                  <span>Peso</span>
                  <span>{{ product.weight }}g</span>
                </li>
                <li class="list-group-item d-flex justify-content-between" *ngIf="product.lifespan">
                  <span>Vida Útil</span>
                  <span>{{ product.lifespan }} ciclos</span>
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between">
                  <span>Formato</span>
                  <span>{{ product.format }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                  <span>Aplicación Principal</span>
                  <span>{{ product.application }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between" *ngIf="product.cells">
                  <span>Número de Celdas</span>
                  <span>{{ product.cells }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between" *ngIf="product.operatingTemperature">
                  <span>Temperatura de Operación</span>
                  <span>{{ product.operatingTemperature }}</span>
                </li>
              </ul>
            </div>
          </div>
          
          <div class="row mt-3">
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between" *ngIf="product.chargeCurrent">
                  <span>Corriente de Carga</span>
                  <span>{{ product.chargeCurrent }}A</span>
                </li>
                <li class="list-group-item d-flex justify-content-between" *ngIf="product.dischargeCurrent">
                  <span>Descarga Continua</span>
                  <span>{{ product.dischargeCurrent }}A</span>
                </li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between" *ngIf="product.pulseDischargeCurrent">
                  <span>Descarga Pulsada (5s)</span>
                  <span>{{ product.pulseDischargeCurrent }}A</span>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Productos relacionados -->
  <div class="row mt-5" *ngIf="relatedProducts.length > 0">
    <div class="col-12">
      <h3 class="mb-4">Productos Relacionados</h3>
      <div class="row">
        <div class="col-lg-3 col-md-6 mb-4" *ngFor="let relatedProduct of relatedProducts">
          <a [routerLink]="['/products', relatedProduct.id]" class="text-decoration-none text-dark">
            <div class="card h-100 border-0 shadow-sm product-card">
              <div class="position-relative">
                <img [src]="relatedProduct.image || 'assets/images/placeholder.jpg'" 
                     class="card-img-top" 
                     [alt]="relatedProduct.name"
                     style="height: 200px; object-fit: cover;">
                <div *ngIf="relatedProduct.discount" class="position-absolute top-0 end-0 bg-danger text-white px-2 py-1 m-2 rounded">
                  -{{ relatedProduct.discount }}%
                </div>
              </div>
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">{{ relatedProduct.name }}</h5>
                <p class="card-text flex-grow-1 text-truncate-2">{{ relatedProduct.description }}</p>
                <div class="mt-auto">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="h5 mb-0" *ngIf="!relatedProduct.discount">${{ relatedProduct.price | number:'1.2-2' }}</span>
                    <div *ngIf="relatedProduct.discount">
                      <span class="h5 mb-0 text-danger">${{ relatedProduct.price * (1 - relatedProduct.discount/100) | number:'1.2-2' }}</span>
                      <div class="small text-muted text-decoration-line-through">${{ relatedProduct.price | number:'1.2-2' }}</div>
                    </div>
                  </div>
                  <button (click)="addToCart($event, relatedProduct)" 
                          class="btn btn-primary w-100">
                    <i class="bi bi-cart-plus"></i> Agregar al carrito
                  </button>
                </div>
              </div>
            </div>
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container my-4" *ngIf="!product">
  <div class="text-center py-5">
    <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
    <h4>Producto no encontrado</h4>
    <p class="text-muted">El producto que buscas no está disponible.</p>
    <a routerLink="/products" class="btn btn-primary">Ver todos los productos</a>
  </div>
</div>